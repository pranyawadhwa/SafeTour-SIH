<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emergency Service Locator - IGDTUW</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; }
        .sidebar { max-height: calc(100vh - 100px); overflow-y: auto; }
        .sos-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 30px;
            background-color: #ff0000;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .sos-button:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="flex">
    <div class="w-80 bg-white border-r p-4">
        <h1 class="text-xl font-bold mb-4">Emergency Locator</h1>
        <div class="flex flex-wrap gap-2 mb-4">
            <button onclick="toggleHospitals()" class="px-3 py-1 bg-red-500 text-white rounded">Hospitals</button>
            <button onclick="togglePharmacies()" class="px-3 py-1 bg-green-500 text-white rounded">Pharmacies</button>
            <button onclick="goToIGDTUW()" class="px-3 py-1 bg-blue-500 text-white rounded">My Location</button>
             <button id="sosButton" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">SOS</button>

        </div>
        <div id="placesList" class="sidebar space-y-3"></div>
    </div>
    <div id="map" class="flex-1"></div>
    

    <script>
        let map;
        const igdtuwLocation = { lat: 28.6575, lon: 77.2290 }; // IGDTUW
        let userMarker = null;
        let hospitalMarkers = [];
        let pharmacyMarkers = [];

        const hospitals = [
            { name: "St. Stephen's Hospital", lat: 28.6521, lon: 77.2306, type: "hospital", time: 7 },
            { name: "Jeewan Mala Hospital", lat: 28.6560, lon: 77.2250, type: "hospital", time: 5 },
            { name: "Sant Parmanand Hospital", lat: 28.6550, lon: 77.2320, type: "hospital", time: 6 }
        ];

        const pharmacies = [
            { name: "Life Care Pharmacy", lat: 28.6580, lon: 77.2285, type: "pharmacy", time: 2 },
            { name: "Emarsons Chemist", lat: 28.6572, lon: 77.2297, type: "pharmacy", time: 1 },
            { name: "Ashok Medicines", lat: 28.6578, lon: 77.2303, type: "pharmacy", time: 1 }
        ];

        function initMap() {
            map = L.map("map").setView([igdtuwLocation.lat, igdtuwLocation.lon], 16);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: "Â© OpenStreetMap contributors"
            }).addTo(map);

            addUserMarker();
            addMarkers(hospitals, hospitalMarkers, "hospital");
            addMarkers(pharmacies, pharmacyMarkers, "pharmacy");
        }

        function addUserMarker() {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker([igdtuwLocation.lat, igdtuwLocation.lon], {
                icon: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png", iconSize: [30, 30] })
            }).addTo(map).bindPopup("ðŸ“ IGDTUW").openPopup();
        }

        function addMarkers(data, markersArray, type) {
            const list = document.getElementById("placesList");
            data.forEach(item => {
                const marker = L.marker([item.lat, item.lon], {
                    icon: L.icon({ 
                        iconUrl: type === "hospital" ? 
                            "https://cdn-icons-png.flaticon.com/512/2972/2972185.png" : 
                            "https://cdn-icons-png.flaticon.com/512/2966/2966211.png", 
                        iconSize: [30, 30] 
                    })
                }).addTo(map)
                    .bindPopup(`<b>${item.name}</b><br>Approx. ${item.time} min from IGDTUW`);

                const div = document.createElement("div");
                div.className = "p-2 border rounded cursor-pointer hover:bg-gray-100";
                div.innerHTML = `<b>${item.name}</b> - ${item.time} min`;
                div.onclick = () => { map.setView([item.lat, item.lon], 17); marker.openPopup(); };
                list.appendChild(div);

                markersArray.push(marker);
            });
        }

        function toggleMarkers(type) {
            const markersArray = type === "hospital" ? hospitalMarkers : pharmacyMarkers;
            markersArray.forEach(marker => {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                } else {
                    marker.addTo(map);
                }
            });
        }

        function toggleHospitals() { toggleMarkers("hospital"); }
        function togglePharmacies() { toggleMarkers("pharmacy"); }

        function goToIGDTUW() {
            map.setView([igdtuwLocation.lat, igdtuwLocation.lon], 16);
            addUserMarker();
        }

        // SOS Button functionality
        // Replace the existing SOS Button functionality with:
// Find the SOS Button event listener and replace with:
document.getElementById('sosButton').addEventListener('click', async () => {
    try {
        const messageBody = {
            message: `EMERGENCY: Need immediate assistance at IGDTUW. Current location: https://www.google.com/maps?q=${igdtuwLocation.lat},${igdtuwLocation.lon}`
        };

        // Update the fetch URL to point to your Express server
        const response = await fetch('http://localhost:3000/send-sos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(messageBody)
        });

        const data = await response.json();
        console.log('Server response:', data); // Debug log
        
        if (data.success) {
            alert('Emergency alert sent successfully!');
        } else {
            alert(`Failed to send emergency alert: ${data.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error sending SOS:', error);
        alert('Failed to send emergency alert. Please check if the server is running.');
    }
});

        initMap();
    </script>
</body>
</html>